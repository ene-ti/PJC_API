unit u_ArtistaService;

interface

uses
  System.Classes,
  System.SysUtils,
  System.Generics.Collections,
  u00_conexao,
  u_ArtistaClass,

  FireDAC.Stan.Intf,
  FireDAC.Stan.Option,
  FireDAC.Stan.Error,
  FireDAC.Stan.Pool,
  FireDAC.Stan.Async,
  FireDAC.Stan.Def,
  FireDAC.UI.Intf,
  FireDAC.Phys.Intf,
  FireDAC.DApt,
  FireDAC.Phys,
  FireDAC.VCLUI.Wait,
  FireDAC.Comp.Client,
  FireDAC.Phys.MySQL,
  FireDAC.Phys.MySQLDef,
  Data.DB;

type
  TArtistaService = class
  private

  public
    class function GetArtistas(const ALikeDescricao: string): TObjectList<TArtista>;
    class function GetArtista(const ACodArtista: Integer): TArtista;
    class procedure Post(const AProduto: TArtista);
    class procedure Update(const AId: Integer; const AProduto: TArtista);
    class procedure Delete(const ACodProduto: Integer);
  end;

implementation

uses u00_Global, u00_FunPro;

{ TArtistaService }

class function TArtistaService.GetArtistas(const ALikeDescricao: string): TObjectList<TArtista>;
var
  FDConexao: TFDConnection;
  TmpDataset: TDataSet;
  Artista: TArtista;
  StrWhere: string;
begin
  Result := TObjectList<TArtista>.Create;

  FDConexao := TFDConnection.Create(nil);
  try
    if ALikeDescricao.Trim.IsEmpty then
      StrWhere := ''
    else
      StrWhere := 'where descricao like ''%' + ALikeDescricao + '%''';

    FDConexao.ConnectionDefName := NOME_CONEXAO_BD;
    FDConexao.ExecSQL('select * from artista ' + StrWhere + ' order by art_id', TmpDataset);

    if not TmpDataset.IsEmpty then
    begin
      TmpDataset.First;
      while not TmpDataset.Eof do
      begin
        Artista := TArtista.Create;
        Artista.art_id   := TmpDataset.FieldByName('art_id').AsInteger;
        Artista.art_nome := TmpDataset.FieldByName('art_nome').AsString;

        Result.Add(Artista);
        TmpDataset.Next;
      end;
    end
    else
      raise EDatabaseError.Create('Nenhum produto cadastrado na base de dados!');
  finally
    TmpDataset.Free;
    FDConexao.Free;
  end;
end;

class function TArtistaService.GetArtista(const ACodArtista: Integer): TArtista;
var
  FDConexao: TFDConnection;
  TmpDataset: TDataSet;
begin
  Result := TArtista.Create;

  FDConexao := TFDConnection.Create(nil);
  try
    FDConexao.ConnectionDefName := NOME_CONEXAO_BD;

    FDConexao.ExecSQL(
      'select * from artista where art_id=' + ACodArtista.ToString,
      TmpDataset
    );

    if not TmpDataset.IsEmpty then
    begin
      Result.art_id        := TmpDataset.FieldByName('ART_ID').AsInteger;
      Result.art_nome      := TmpDataset.FieldByName('ART_NOME').AsString;
    end
    else
      raise EDatabaseError.CreateFmt('Produto "%d" não encontrado na base de dados!', [ACodArtista]);
  finally
    TmpDataset.Free;
    FDConexao.Free;
  end;
end;

class procedure TArtistaService.Delete(const ACodProduto: Integer);
var
  FDConexao: TFDConnection;
  CountDelete: Integer;
begin
  FDConexao := TFDConnection.Create(nil);
  try
    FDConexao.ConnectionDefName := NOME_CONEXAO_BD;

    CountDelete := FDConexao.ExecSQL(
      'delete from produtos where ID=?',
      [ACodProduto],
      [ftInteger]
    );

    if CountDelete = 0 then
      raise EDatabaseError.Create('Nenhum produto foi excluido!');
  finally
    FDConexao.Free;
  end;
end;



class procedure TArtistaService.Post(const AProduto: TProduto);
var
  FDConexao: TFDConnection;
const
  SQL_INSERT: string =
    'INSERT INTO PRODUTOS (                                ' + sLineBreak +
    '  ID, GTIN, DESCRICAO, VL_VENDA, DT_CRIACAO, UN       ' + sLineBreak +
    ') VALUES (                                            ' + sLineBreak +
    '  (select coalesce(max(id) , 0) + 1 from produtos), :GTIN, :DESCRICAO, :VL_VENDA, CURRENT_TIMESTAMP, :UN ' + sLineBreak +
    ')                                                     ' ;
begin
  if AProduto.Descricao.Trim.IsEmpty then
    raise EDatabaseError.Create('Descrição do produto é obrigatória');

  if AProduto.ValorVenda <= 0 then
    raise EDatabaseError.Create('valor do produto deve ser um valor maior que zero');

  FDConexao := TFDConnection.Create(nil);
  try
    FDConexao.ConnectionDefName := NOME_CONEXAO_BD;
    FDConexao.ExecSQL(SQL_INSERT,
      [
        Aproduto.Gtin,
        Aproduto.Descricao,
        Aproduto.ValorVenda,
        Aproduto.Unidade
      ],
      [
        ftString,
        ftString,
        ftFloat,
        ftString
      ]
    );
  finally
    FDConexao.Free;
  end;
end;

class procedure TArtistaService.Update(const AId: Integer; const AProduto: TProduto);
var
  FDConexao: TFDConnection;
  CountAtu: Integer;

const
  SQL_UPDATE: string =
    'UPDATE PRODUTOS SET         ' + sLineBreak +
    '  GTIN = :GTIN,             ' + sLineBreak +
    '  DESCRICAO = :DESCRICAO,   ' + sLineBreak +
    '  VL_VENDA = :VL_VENDA,     ' + sLineBreak +
    '  UN = :UN                  ' + sLineBreak +
    'WHERE (ID = :ID)            ';
begin
  if AProduto.Descricao.Trim.IsEmpty then
    raise EDatabaseError.Create('Descrição do produto é obrigatória');

  if AProduto.ValorVenda <= 0 then
    raise EDatabaseError.Create('valor do produto deve ser um valor maior que zero');

  FDConexao := TFDConnection.Create(nil);
  try
    FDConexao.ConnectionDefName := NOME_CONEXAO_BD;
    CountAtu := FDConexao.ExecSQL(SQL_UPDATE,
      [
        Aproduto.Gtin,
        Aproduto.Descricao,
        Aproduto.ValorVenda,
        Aproduto.Unidade,
        AId
      ],
      [
        ftString,
        ftString,
        ftFloat,
        ftString,
        ftInteger
      ]
    );

    if CountAtu <= 0 then
      raise Exception.Create('Nenhum produto foi atualizado');
  finally
    FDConexao.Free;
  end;
end;

end.

